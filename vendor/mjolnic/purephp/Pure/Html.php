<?php

/**
 * @method string a(array $attr = array(), string $content = null) Defines a hyperlink
 * @method string abbr(array $attr = array(), string $content = null) Defines an abbreviation
 * @method string address(array $attr = array(), string $content = null) Defines contact information for the author/owner of a document
 * @method string area(array $attr = array(), string $content = null) Defines an area inside an image-map
 * @method string article(array $attr = array(), string $content = null) Defines an article
 * @method string aside(array $attr = array(), string $content = null) Defines content aside from the page content
 * @method string audio(array $attr = array(), string $content = null) Defines sound content
 * @method string b(array $attr = array(), string $content = null) Defines bold text
 * @method string base(array $attr = array(), string $content = null) Specifies the base URL/target for all relative URLs in a document
 * @method string bdi(array $attr = array(), string $content = null) Isolates a part of text that might be formatted in a different direction from other text outside it
 * @method string bdo(array $attr = array(), string $content = null) Overrides the current text direction
 * @method string blockquote(array $attr = array(), string $content = null) Defines a section that is quoted from another source
 * @method string body(array $attr = array(), string $content = null) Defines the document's body
 * @method string br(array $attr = array(), string $content = null) Defines a single line break
 * @method string button(array $attr = array(), string $content = null) Defines a clickable button
 * @method string canvas(array $attr = array(), string $content = null) Used to draw graphics, on the fly, via scripting (usually JavaScript)
 * @method string caption(array $attr = array(), string $content = null) Defines a table caption
 * @method string cite(array $attr = array(), string $content = null) Defines the title of a work
 * @method string code(array $attr = array(), string $content = null) Defines a piece of computer code
 * @method string col(array $attr = array(), string $content = null) Specifies column properties for each column within a 'colgroup' element 
 * @method string colgroup(array $attr = array(), string $content = null) Specifies a group of one or more columns in a table for formatting
 * @method string command(array $attr = array(), string $content = null) Defines a command button that a user can invoke
 * @method string datalist(array $attr = array(), string $content = null) Specifies a list of pre-defined options for input controls
 * @method string dd(array $attr = array(), string $content = null) Defines a description/value of a term in a description list
 * @method string del(array $attr = array(), string $content = null) Defines text that has been deleted from a document
 * @method string details(array $attr = array(), string $content = null) Defines additional details that the user can view or hide
 * @method string dfn(array $attr = array(), string $content = null)
 * @method string dialog(array $attr = array(), string $content = null)
 * @method string div(array $attr = array(), string $content = null)
 * @method string dl(array $attr = array(), string $content = null)
 * @method string dt(array $attr = array(), string $content = null)
 * @method string em(array $attr = array(), string $content = null)
 * @method string embed(array $attr = array(), string $content = null)
 * @method string fieldset(array $attr = array(), string $content = null)
 * @method string figcaption(array $attr = array(), string $content = null)
 * @method string figure(array $attr = array(), string $content = null)
 * @method string footer(array $attr = array(), string $content = null)
 * @method string form(array $attr = array(), string $content = null)
 * @method string h1(array $attr = array(), string $content = null)
 * @method string h2(array $attr = array(), string $content = null)
 * @method string h3(array $attr = array(), string $content = null)
 * @method string h4(array $attr = array(), string $content = null)
 * @method string h5(array $attr = array(), string $content = null)
 * @method string h6(array $attr = array(), string $content = null)
 * @method string head(array $attr = array(), string $content = null)
 * @method string header(array $attr = array(), string $content = null)
 * @method string hgroup(array $attr = array(), string $content = null)
 * @method string hr(array $attr = array(), string $content = null)
 * @method string html(array $attr = array(), string $content = null)
 * @method string i(array $attr = array(), string $content = null)
 * @method string iframe(array $attr = array(), string $content = null)
 * @method string img(array $attr = array(), string $content = null)
 * @method string input(array $attr = array(), string $content = null)
 * @method string ins(array $attr = array(), string $content = null)
 * @method string kbd(array $attr = array(), string $content = null)
 * @method string keygen(array $attr = array(), string $content = null)
 * @method string label(array $attr = array(), string $content = null)
 * @method string legend(array $attr = array(), string $content = null)
 * @method string li(array $attr = array(), string $content = null)
 * @method string link(array $attr = array(), string $content = null)
 * @method string map(array $attr = array(), string $content = null)
 * @method string mark(array $attr = array(), string $content = null)
 * @method string menu(array $attr = array(), string $content = null)
 * @method string meta(array $attr = array(), string $content = null)
 * @method string meter(array $attr = array(), string $content = null)
 * @method string nav(array $attr = array(), string $content = null)
 * @method string noscript(array $attr = array(), string $content = null)
 * @method string object(array $attr = array(), string $content = null)
 * @method string ol(array $attr = array(), string $content = null)
 * @method string optgroup(array $attr = array(), string $content = null)
 * @method string option(array $attr = array(), string $content = null)
 * @method string output(array $attr = array(), string $content = null)
 * @method string p(array $attr = array(), string $content = null)
 * @method string param(array $attr = array(), string $content = null)
 * @method string pre(array $attr = array(), string $content = null)
 * @method string progress(array $attr = array(), string $content = null)
 * @method string q(array $attr = array(), string $content = null)
 * @method string rp(array $attr = array(), string $content = null)
 * @method string rt(array $attr = array(), string $content = null)
 * @method string ruby(array $attr = array(), string $content = null)
 * @method string s(array $attr = array(), string $content = null)
 * @method string samp(array $attr = array(), string $content = null)
 * @method string script(array $attr = array(), string $content = null)
 * @method string section(array $attr = array(), string $content = null)
 * @method string select(array $attr = array(), string $content = null)
 * @method string small(array $attr = array(), string $content = null)
 * @method string source(array $attr = array(), string $content = null)
 * @method string span(array $attr = array(), string $content = null)
 * @method string strong(array $attr = array(), string $content = null)
 * @method string style(array $attr = array(), string $content = null)
 * @method string sub(array $attr = array(), string $content = null)
 * @method string summary(array $attr = array(), string $content = null)
 * @method string sup(array $attr = array(), string $content = null)
 * @method string table(array $attr = array(), string $content = null)
 * @method string tbody(array $attr = array(), string $content = null)
 * @method string td(array $attr = array(), string $content = null)
 * @method string textarea(array $attr = array(), string $content = null)
 * @method string tfoot(array $attr = array(), string $content = null)
 * @method string th(array $attr = array(), string $content = null)
 * @method string thead(array $attr = array(), string $content = null)
 * @method string time(array $attr = array(), string $content = null)
 * @method string title(array $attr = array(), string $content = null)
 * @method string tr(array $attr = array(), string $content = null)
 * @method string track(array $attr = array(), string $content = null)
 * @method string u(array $attr = array(), string $content = null)
 * @method string ul(array $attr = array(), string $content = null)
 * @method string var(array $attr = array(), string $content = null)
 * @method string video(array $attr = array(), string $content = null)
 * @method string wbr(array $attr = array(), string $content = null)
 * @method string main(array $attr = array(), string $content = null)
 */
class Pure_Html {

    /**
     * List of HTML5 void elements (self closing tag)
     * @var array
     */
    protected static $void_elements = array('area', 'base', 'br', 'col', 'command', 'embed',
        'hr', 'img', 'input', 'keygen', 'link', 'meta', 'param', 'source', 'track', 'wbr');

    /**
     *
     * @var Pure_Html 
     */
    protected static $instance = null;

    /**
     * 
     * @return Pure_Html
     */
    public static function getInstance() {
        if (is_null(self::$instance)) {
            self::$instance = new self();
        }
        return self::$instance;
    }
    
    public static function doc($content, $doctype = '<!DOCTYPE html>', $head = '<html><head></head><body>', $foot = '</body></html>'){
        return implode("\n", array($doctype, $head, $content, $foot));
    }

    /**
     * Converts a key-value pair array into a html-attr string
     * @param array $arr
     * @return string 
     */
    public function htmlAttr($arr) {
        if (is_string($arr)) {
            return $arr;
        }
        if (is_object($arr)) {
            $arr = (array) $arr;
        }

        if (!is_array($arr) || (count($arr) == 0)) {
            return '';
        }

        $str = '';
        foreach ($arr as $key => $value) {
            $str.=($key . '="' . $value . '" ');
        }
        $str = trim($str);
        return !empty($str) ? ' ' . $str : null;
    }

    /**
     * 
     * @param string $tagname
     * @param string|array $content String or array (for selects, uls, tables, navs, audio or video sources, ...
     * @return string
     */
    public function htmlContent($tagname, $content) {
        $tagname = strtolower($tagname);
        $str = '';
        if (is_array($content)) {
            foreach ($content as $i => $c) {
                //option
                if (($tagname == 'select') or ($tagname == 'optgroup') or
                        ($tagname == 'datalist')) {
                    $str .= $this->option(array('value' => $i), $c) . "\n";
                    //li
                } elseif (($tagname == 'ul') or ($tagname == 'ol')) {
                    $str .= $this->li(null, $c) . "\n";
                    //td
                } elseif ($tagname == 'tr') {
                    $str .= $this->td(null, $c) . "\n";
                    //tr + td
                } elseif (($tagname == 'table') or ($tagname == 'thead') or
                        ($tagname == 'tbody') or ($tagname == 'tfoot')) {
                    if (is_array($c)) {
                        $str .= $this->trOpen() . "\n";
                        foreach ($c as $j => $tdc) {
                            $str .= "\t" . $this->td(null, $tdc);
                        }
                        $str .= $this->trClose() . "\n";
                    } else {
                        $str .= $this->tr(null, $this->td(null, $c)) . "\n";
                    }
                    //a
                } elseif ($tagname == 'nav') {
                    $str .= $this->a(array('href' => $i), $c) . "\n";
                    //source
                } elseif (($tagname == 'audio') or ($tagname == 'video')) {
                    $str .= $this->source(array('src' => $i, 'type' => $c)) . "\n";
                } else {
                    $str .= strval($c) . ' ';
                }
            }
            $str = trim($str);
        } else {
            $str = strval($content);
        }
        return $str;
    }

    /**
     * 
     * @param string $tagname
     * @param array $attr
     * @param string|array $content String or array (for selects, uls, tables, navs, audio or video sources, ...
     * @return type
     */
    public function htmlTag($tagname, $attr = array(), $content = null) {
        $tagname = strtolower($tagname);
        return $this->htmlTagOpen($tagname, $attr) . $this->htmlContent($tagname, $content) . $this->htmlTagClose($tagname);
    }

    public function htmlTagOpen($tagname, $attr = array()) {
        $tagname = strtolower($tagname);
        if (!in_array($tagname, self::$void_elements)) {
            return "<$tagname" . rtrim($this->htmlAttr($attr)) . ">";
        } else {
            return "<$tagname" . $this->htmlAttr($attr);
        }
    }

    public function htmlTagClose($tagname) {
        $tagname = strtolower($tagname);
        if (in_array($tagname, self::$void_elements))
            return " />\n";
        else
            return "</{$tagname}>\n";
    }

    public function htmlAttrPluck($str, $tagname = 'a|img', $attrname = 'href|src') {
        $tagname = strtolower($tagname);
        preg_match_all('/<' . $tagname . '[^>]+>/i', $str, $result);
        $elems = array();
        foreach ($result as $i => $elem) {
            preg_match_all('/(' . $attrname . ')=("[^"]*")/i', $elem, $elems[$i]);
        }
        $values = array();
        foreach ($elems as $i => $elem) {
            if (isset($elem[2]) && isset($elem[2][0])) {
                $values[] = $elem[2][0];
            }
        }
        return $values;
    }

    public function htmlAddLinks($str, $target_blank = false) {
        if ($target_blank)
            $target_blank = ' target="_blank" ';
        return str_replace('&', '&amp;', preg_replace('/([\w]+:\/\/[\w-?&;#~=\.\/\@]+[\w\/])/i', '<a' .
                        $target_blank . ' href="$1">$1</a>', $str));
    }

    public function htmlWrapWords($string, $words, $tagName = 'mark', $tagAttrs = array()) {
        if (!is_array($words))
            $words = array($words);
        $string = strip_tags($string);
        foreach ($words as $word) {
            $string = str_ireplace($word, $this->htmlTag($tagName, $tagAttrs, $word), $string);
        }
        return $string;
    }

    public function __call($name, $arguments) {
        array_unshift($arguments, str_replace(array('Open', 'Close'), '', $name));

        if (preg_match('/Open$/i', $name)) {
            return call_user_func_array(array($this, 'htmlTagOpen'), $arguments);
        } elseif (preg_match('/Close$/i', $name)) {
            return call_user_func_array(array($this, 'htmlTagClose'), $arguments);
        } else {
            return call_user_func_array(array($this, 'htmlTag'), $arguments);
        }
    }

}